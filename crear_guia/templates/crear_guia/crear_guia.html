{% extends "core/core.html" %}
{% load static %}

{% block title %}{% if object %}Editar Guía{% else %}Crear Nueva Guía{% endif %}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'crear_guia/css/crear_guia.css' %}">
{% endblock %}

{% block content %}
<div class="container">
  <h1>{% if object %}Editar Guía{% else %}Crear Nueva Guía{% endif %}</h1>
  <form id="guia-form" method="post" enctype="multipart/form-data" action="">
    {% csrf_token %}
    <div>
      <label for="id_title">Título:</label>
      {{ form.title }}
    </div>
    <div>
      <label for="id_description">Descripción:</label>
      {{ form.description }}
    </div>
    <div>
      <label for="id_category">Categoría:</label>
      {{ form.category }}
    </div>
    <div>
      <label for="id_image">Imagen Representativa:</label>
      {{ form.image }}
    </div>

    {% if request.user.es_escritor %}
      <div>
        <label for="id_code_file">Código de la Guía (.zip):</label>
        {{ form.code_file }}
      </div>
    {% endif %}

    <!-- Barra de herramientas para agregar bloques -->
    <div class="toolbar">
      <button type="button" data-type="text">Agregar Texto</button>
      <button type="button" data-type="latex">Agregar LaTeX</button>
      <button type="button" data-type="code">Agregar Código</button>
    </div>

    <!-- Área de edición -->
    <div id="editor">
      {% if object and object.pk and object.blocks.exists %}
        {% for block in object.blocks.all %}
          {% if block.block_type == 'text' %}
            <div class="editor-block block-text" draggable="true">
              <textarea rows="5">{{ block.content|safe }}</textarea>
            </div>
          {% elif block.block_type == 'latex' %}
            <div class="editor-block block-latex" draggable="true">
              <textarea rows="5">{{ block.content|safe }}</textarea>
            </div>
          {% elif block.block_type == 'code' %}
            <div class="editor-block block-code" draggable="true">
              <textarea rows="5">{{ block.content|safe }}</textarea>
            </div>
          {% endif %}
        {% endfor %}
      {% else %}
        <!-- Bloque inicial vacío -->
        <div class="editor-block block-text" draggable="true">
          <textarea rows="5" placeholder="Escribe el contenido de la guía aquí..."></textarea>
        </div>
      {% endif %}
    </div>

    <!-- Campo oculto para los bloques en JSON -->
    <input type="hidden" id="blocks-input" name="blocks" />

    <div class="buttons-container">
      <button type="submit" id="submit-btn">{% if object %}Guardar Guía{% else %}Crear Guía{% endif %}</button>
      {% if object %}
        {# Se agrega el atributo data-url para obtener la URL correcta #}
        <button type="button" id="publish-btn" data-guide-id="{{ object.pk }}" data-url="{% url 'toggle_publish' object.pk %}">
          {% if object.publicado %}
            Publicado
          {% else %}
            Publicar Guía
          {% endif %}
        </button>
      {% endif %}
    </div>
  </form>
</div>

<!-- Overlay de carga -->
<div id="loadingOverlay" style="display: none;">
  <div class="modal-content">
    <div class="spinner"></div>
    <p style="color: var(--text); font-size: 0.9rem; text-align: center;">Por favor espere...</p>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'crear_guia/js /crear_guia.js' %}"></script>
{% endblock %}
