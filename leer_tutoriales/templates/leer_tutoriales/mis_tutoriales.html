{% extends "core/core.html" %}
{% block title %}{{ tutorial.title }} | WebDev Blog{% endblock %}

{% block extra_head %}
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script" async></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/default.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>

  <style>
    :root {
      --primary: #2563eb;
      --secondary: #3b82f6;
      --text: #1e293b;
      --background: #ffffff;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --radius: 8px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    [data-theme="dark"] {
      --primary: #60a5fa;
      --secondary: #3b82f6;
      --text: #f8fafc;
      --background: #0f172a;
      --gray-100: #1e293b;
      --gray-200: #334155;
    }
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      color: var(--text);
      background-color: var(--background);
      line-height: 1.6;
      transition: background-color 0.3s, color 0.3s;
    }
    a { text-decoration: none; color: var(--primary); }
    img { max-width: 100%; display: block; }

    /* Navbar */
    .navbar {
      position: sticky;
      top: 0;
      backdrop-filter: blur(10px);
      background-color: rgba(241,245,249, 0.8);
      z-index: 1000;
      border-bottom: 1px solid var(--gray-200);
    }
    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary); transition: color 0.3s; }
    .nav-menu { display: flex; gap: 2rem; align-items: center; list-style: none; }
    .nav-link {
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      font-weight: 500;
      transition: all 0.3s ease;
      color: var(--text);
    }
    .nav-link:hover,
    .nav-link.active { background-color: var(--gray-100); }
    .nav-cta {
      background-color: var(--primary);
      color: #fff;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius);
      transition: background-color 0.3s ease;
    }
    .nav-cta:hover { background-color: var(--secondary); }
    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
    }
    @media (max-width: 768px) {
      .nav-menu {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: var(--background);
        padding: 1rem;
        flex-direction: column;
        box-shadow: var(--shadow);
      }
      .nav-menu.active { display: flex; }
      .mobile-menu-btn { display: block; }
    }

    /* Layout Principal */
    .container {
      max-width: 1200px;
      margin: 3rem auto;
      padding: 0 1rem;
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
    }
    @media (min-width: 1024px) { .container { grid-template-columns: 3fr 1fr; } }
    article {
      padding: 2rem;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      background-color: var(--background);
    }
    .tutorial-header {
      border-bottom: 1px solid var(--gray-200);
      padding-bottom: 1rem;
      margin-bottom: 0.1rem;
    }
    .tutorial-header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; color: var(--text); }
    .tutorial-meta {
      font-size: 0.9rem;
      color: var(--text);
      background-color: var(--gray-100);
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius);
      display: inline-block;
      margin-bottom: 0.1rem;
    }
    .tutorial-content { font-size: 1.125rem; line-height: 1.8; }
    .tutorial-content h2 { margin: 2rem 0 1rem; font-size: 1.75rem; color: var(--primary); }
    .tutorial-content p { margin-bottom: 1rem; }
    .back-button {
      display: inline-block;
      margin-top: 2rem;
      padding: 0.75rem 1.5rem;
      background-color: var(--primary);
      color: #fff;
      border-radius: var(--radius);
      transition: background-color 0.3s;
    }
    .back-button:hover { background-color: var(--secondary); }

    /* Bloques del Tutorial */
    .tutorial-block { margin-bottom: 1rem; }
    .block-text { text-align: justify; }
    .block-latex {
      background-color: #f9f9f9;
      border-left: 4px solid var(--primary);
      padding: 1rem;
    }
    .block-code {
      background-color: var(--gray-100);
      border-left: 4px solid var(--secondary);
      padding: 0.25rem 0.5rem;
      font-family: "Courier New", monospace;
      white-space: pre-wrap;
    }
    .hljs {
      margin: 0 !important;
      padding: 0 !important;
      line-height: 1.2 !important;
      background: none !important;
    }
    .block-code pre,
    .block-code code {
      margin: 0 !important;
      padding: 0 !important;
      line-height: 1.2 !important;
      display: block;
    }

    /* TOC */
    .toc {
      position: sticky;
      top: 2rem;
      background-color: var(--gray-100);
      padding: 1rem;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      max-height: 80vh;
      overflow-y: auto;
    }
    .toc h2 { font-size: 1.25rem; margin-bottom: 1rem; color: var(--primary); }
    .toc ul { list-style: none; padding-left: 0; }
    .toc ul li { margin-bottom: 0.5rem; }
    .toc ul li a {
      color: var(--text);
      font-size: 0.95rem;
      transition: color 0.3s;
    }
    .toc ul li a:hover { color: var(--secondary); }

    /* Footer */
    .footer {
      background-color: var(--gray-100);
      padding: 4rem 2rem 2rem;
      margin-top: 4rem;
      border-top: 1px solid var(--gray-200);
    }
    .footer-container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
    }
    .footer-section h3,
    .footer-section h4 { color: var(--primary); margin-bottom: 1rem; }
    .footer-section ul { list-style: none; padding: 0; }
    .footer-section ul li { margin-bottom: 0.75rem; }
    .footer-section ul li a {
      color: var(--text);
      transition: color 0.3s;
    }
    .footer-section ul li a:hover { color: var(--primary); }
    .social-links { display: flex; gap: 1rem; }
    .social-links a {
      color: var(--text);
      font-size: 1.25rem;
      transition: color 0.3s;
    }
    .social-links a:hover { color: var(--primary); }
    .footer-newsletter { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .footer-newsletter input {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
    }
    .footer-newsletter button {
      background-color: var(--primary);
      color: #fff;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .footer-newsletter button:hover { background-color: var(--secondary); }
    .footer-bottom {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid var(--gray-200);
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .legal-links {
      list-style: none;
      padding: 0;
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
    .legal-links a {
      color: var(--text);
      transition: color 0.3s;
    }
    .legal-links a:hover { color: var(--primary); }

    /* Botón de cambio de tema */
    .theme-toggle {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background-color: var(--gray-100);
      border: none;
      padding: 0.75rem;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: transform 0.3s;
    }
    .theme-toggle:hover { transform: scale(1.1); }

    /* Sección de Comentarios - Mejorada */
.comments-section {
  margin-top: 4rem;
  padding: 2.5rem;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius);
  background-color: var(--background);
  box-shadow: var(--shadow);
}

.comments-section h2 {
  font-size: 1.75rem;
  color: var(--primary);
  margin-bottom: 1.5rem;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid var(--primary);
}

/* Formulario de Comentarios */
.comment-form .form-group {
  margin-bottom: 1.5rem;
}

.comment-form label {
  font-weight: 600;
  color: var(--primary);
  margin-bottom: 0.75rem;
  display: block;
}

.comment-form textarea {
  width: 100%;
  min-height: 150px;
  padding: 1rem;
  border: 2px solid var(--gray-200);
  border-radius: var(--radius);
  background: var(--background);
  color: var(--text);
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.comment-form textarea:focus {
  border-color: var(--primary);
  outline: none;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
}

.submit-comment {
  width: 100%;
  font-size: 1rem;
  font-weight: 600;
  background-color: var(--primary);
  color: #fff;
  padding: 0.75rem;
  border: none;
  border-radius: var(--radius);
  cursor: pointer;
  transition: transform 0.2s ease, background-color 0.3s ease;
  margin-top: 1rem;
}

.submit-comment:hover {
  transform: translateY(-2px);
  background-color: var(--secondary);
}

/* Lista de Comentarios */
.comments-list {
  margin-top: 3rem;
}

.comment {
  position: relative;
  padding: 1.5rem;
  margin: 1.5rem 0;
  background: var(--gray-100);
  border-radius: var(--radius);
  border: 1px solid var(--gray-200);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.comment:hover {
  transform: translateX(5px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.comment-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.comment-author {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.comment-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--primary);
  padding: 2px;
  background: var(--background);
}

.comment-author-info {
  display: flex;
  flex-direction: column;
}

.comment-author-name {
  font-weight: 600;
  color: var(--primary);
}

.comment-date {
  font-size: 0.875rem;
  color: var(--gray-500);
}

/* Sistema de Valoración */
.star-rating {
  display: inline-flex;
  flex-direction: row-reverse;
  align-items: center;
  gap: 0.25rem;
}

.star-rating input[type="radio"] {
  display: none;
}

.star-rating label {
  cursor: pointer;
  font-size: 1.25rem;
  transition: color 0.2s ease;
}

.star-rating .fas.fa-star {
  color: var(--gray-300);
}

.star-rating .fas.fa-star.active,
.star-rating input[type="radio"]:checked ~ label .fas.fa-star {
  color: #f59e0b;
}

/* Respuestas */
.comment-reply {
  margin-left: 3rem;
  margin-top: 1.5rem;
  padding-left: 1.5rem;
  border-left: 3px solid var(--secondary);
  position: relative;
}

.comment-reply::before {
  content: '';
  position: absolute;
  left: -3px;
  top: -1.5rem;
  height: 1.5rem;
  width: 3px;
  background: var(--secondary);
}

.reply-header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 0.5rem;
}

.reply-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--secondary);
  padding: 2px;
  background: var(--background);
}

.reply-author {
  font-weight: 600;
  color: var(--secondary);
}

/* Reacciones en Comentarios */
.comment-reactions {
  margin-top: 1rem;
  display: flex;
  gap: 1rem;
}

.comment-reactions .reaction-button {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.comment-reactions .reaction-button:hover {
  transform: scale(1.1);
}

.comment-reactions .reaction-button svg {
  width: 20px;
  height: 20px;
  fill: var(--gray-400);
  transition: fill 0.3s ease;
}

.comment-reactions .reaction-button.active svg {
  fill: var(--primary);
}

.comment-reactions .reaction-button span {
  font-size: 0.875rem;
  color: var(--text);
}

/* Overlay de Carga - Debe cubrir toda la pantalla */
#loadingOverlay {
  position: fixed;           /* Posición fija para cubrir toda la ventana */
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);  /* Fondo semi-transparente */
  display: none;             /* Oculto por defecto */
  z-index: 9999;             /* Asegura que quede por encima de todos los elementos */
  align-items: center;       /* Centra verticalmente el contenido */
  justify-content: center;   /* Centra horizontalmente el contenido */
  animation: fadeIn 0.3s ease;  /* Animación de aparición */
}

/* Animación para el overlay */
@keyframes fadeIn {
  from { opacity: 0; }
  to   { opacity: 1; }
}

/* Estilos para el contenido del modal */
.modal-content {
  background: var(--background);
  padding: 20px 30px;
  border-radius: var(--radius);
  text-align: center;
  box-shadow: var(--shadow);
}

/* Spinner animado */
.spinner {
  border: 4px solid var(--gray-200);
  border-top: 4px solid var(--primary);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto 1rem auto;
}

/* Animación del spinner */
@keyframes spin {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}

.delete-comment-button {
  background-color: var(--secondary);
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 14px;
  line-height: 20px;
  text-align: center;
  cursor: pointer;
  padding: 0;
  margin-left: 1rem;
  transition: background-color 0.3s;
}
.delete-comment-button:hover {
  background-color: var(--primary);
}

  </style>
{% endblock %}

{% block content %}
  <main class="container">
    <article>
      <header class="tutorial-header">
        <h1>{{ tutorial.title }}</h1>
        <p class="tutorial-meta">
          Duración: {{ tutorial.duration|default:"Desconocida" }} | Nivel: {{ tutorial.level|default:"General" }}
        </p>
      </header>
      <section class="tutorial-content">
        {% for block in tutorial.blocks.all %}
          {% if block.block_type == 'text' %}
            <div class="tutorial-block block-text">{{ block.content|safe }}</div>
          {% elif block.block_type == 'latex' %}
            <div class="tutorial-block block-latex">{{ block.content|safe }}</div>
          {% elif block.block_type == 'code' %}
            <div class="tutorial-block block-code">{{ block.content|safe }}</div>
          {% else %}
            <div class="tutorial-block block-text">{{ block.content|safe }}</div>
          {% endif %}
        {% endfor %}
      </section>
      <a href="{% url 'tutoriales_home' %}" class="back-button">← Volver a Tutoriales</a>
    </article>
    <aside class="toc">
      <h2>Contenido</h2>
      <ul>
        <li><a href="#introduccion">Introducción</a></li>
        <li><a href="#instalacion">Instalación y Configuración</a></li>
        <li><a href="#componentes">Componentes y Arquitectura</a></li>
        <li><a href="#hooks">Hooks Avanzados</a></li>
        <li><a href="#enrutamiento">Enrutamiento</a></li>
        <li><a href="#estado">Estado Global</a></li>
        <li><a href="#apis">Integración con APIs</a></li>
      </ul>
    </aside>

    <!-- Sección de Comentarios y Valoraciones -->
    <section id="comments" class="comments-section">
      <h2>Comentarios y Valoraciones</h2>
      <form class="comment-form" method="post" action="{% url 'tutorial_detail' pk=tutorial.pk %}">
        {% csrf_token %}
        {{ form.non_field_errors }}
        <div class="form-group">
          {{ form.content.label_tag }}
          {{ form.content }}
          {% for error in form.content.errors %}
            <div class="error">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="star-rating">
  {% for i in "54321" %}
    <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}"
           {% if form.rating.value|stringformat:"s" == i %}checked{% endif %} required>
    <label for="star{{ i }}" title="{{ i }} estrella{% if i != '1' %}s{% endif %}">
      <i class="fas fa-star"></i>
    </label>
  {% endfor %}
</div>


        <button type="submit" class="submit-comment">Enviar Comentario</button>
      </form>

      <div class="comments-list">
        {% for comment in tutorial.comments.all %}
  <div class="comment" id="comment-{{ comment.id }}">
    <!-- Cabecera y cuerpo del comentario -->
    <div class="comment-header">
      <span class="comment-author">
        {% if comment.author.profile_image %}
          <img src="{{ comment.author.profile_image.url }}" alt="Foto de {{ comment.author.get_full_name|default:comment.author.username }}" class="comment-avatar">
        {% else %}
          <!-- Imagen por defecto: SVG para el perfil -->
          <svg class="comment-avatar" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128">
            <defs>
              <radialGradient id="gradAvatar" cx="50%" cy="50%" r="50%">
                <stop offset="0%" stop-color="#60a5fa"/>
                <stop offset="100%" stop-color="#2563eb"/>
              </radialGradient>
            </defs>
            <circle cx="64" cy="64" r="60" fill="url(#gradAvatar)"/>
            <circle cx="64" cy="50" r="20" fill="#ffffff"/>
            <path d="M44,90c0-10,8-18,20-18s20,8,20,18v6H44V90z" fill="#ffffff"/>
          </svg>
        {% endif %}
        {{ comment.author.get_full_name|default:comment.author.username }}
      </span>
      <span class="comment-rating">
        {% for star in "12345" %}
          {% if forloop.counter <= comment.rating %}
            <i class="fas fa-star"></i>
          {% endif %}
        {% endfor %}
      </span>
      {% if request.user == comment.author %}
        <button class="delete-comment-button" data-comment-id="{{ comment.id }}">×</button>
      {% endif %}
    </div>
    <div class="comment-body">
      <p>{{ comment.content }}</p>
    </div>
    <div class="comment-reactions">
      <!-- Aquí van los botones de "Me gusta", "No me gusta" y "Responder" -->
      <div class="reaction-button like-button {% if request.user in comment.likes.all %}active{% endif %}" data-comment-id="{{ comment.id }}" data-reaction="like">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M2 20h2v-9H2v9zm20-10c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L13 2 7.59 7.41C7.21 7.79 7 8.3 7 8.83V19c0 1.1.9 2 2 2h7c.79 0 1.48-.47 1.78-1.17l3.02-7.05c.09-.23.14-.47.14-.73v-1z"/>
        </svg>
        <span class="like-text">Me gusta</span>
        <span class="like-count">{{ comment.likes.count }}</span>
      </div>
      <div class="reaction-button dislike-button {% if request.user in comment.dislikes.all %}active{% endif %}" data-comment-id="{{ comment.id }}" data-reaction="dislike">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M22 4h-2v9h2V4zm-12 10H3c-.79 0-1.48.47-1.78 1.17L.2 17.22c-.09.23-.14.47-.14.73v1h7V4h2v10zm12-4c0 1.1-.9 2-2 2h-6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L11 22l5.41-5.41c.38-.38.59-.89.59-1.42V6h2z"/>
        </svg>
        <span class="dislike-text">No me gusta</span>
        <span class="dislike-count">{{ comment.dislikes.count }}</span>
      </div>
      <div class="reaction-button reply-button" data-comment-id="{{ comment.id }}">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M10 9V5l-7 7 7 7v-4.1c4.55 0 7.76 1.72 10 5.1-1-5-4-10-10-10z"/>
        </svg>
        <span class="reply-text">Responder</span>
      </div>
    </div>

    <!-- Formulario de respuesta (inicialmente oculto) -->
    <div class="reply-form" id="reply-form-{{ comment.id }}" style="display: none; margin-top: 1rem;">
      <form method="post" action="{% url 'tutorial_detail' pk=tutorial.pk %}">
        {% csrf_token %}
        <!-- Campo oculto para indicar el comentario padre -->
        <input type="hidden" name="parent" value="{{ comment.id }}">
        <!-- Campo oculto para rating (valor por defecto 5, por ejemplo) -->
        <input type="hidden" name="rating" value="5">
        <!-- Campo para el contenido de la respuesta -->
        <textarea name="content" placeholder="Escribe tu respuesta..." required style="width: 100%; padding: 1rem; border: 2px solid var(--gray-200); border-radius: var(--radius);"></textarea>
        <button type="submit" class="submit-comment" style="margin-top: 0.5rem;">Enviar Respuesta</button>
      </form>
    </div>

    <!-- Si el comentario tiene respuestas, agregamos un botón para mostrarlas -->
    {% if comment.replies.all %}
      <button class="toggle-replies-button" data-comment-id="{{ comment.id }}">
        Ver respuestas ({{ comment.replies.count }})
      </button>
      <div class="comment-replies" id="replies-{{ comment.id }}" style="display: none;">
        {% for reply in comment.replies.all %}
          <div class="comment comment-reply" id="comment-{{ reply.id }}">
            <div class="reply-header">
              <span class="reply-author">
                {% if reply.author.profile_image %}
                  <img src="{{ reply.author.profile_image.url }}" alt="Foto de {{ reply.author.get_full_name|default:reply.author.username }}" class="reply-avatar">
                {% else %}
                  <svg class="comment-avatar" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128">
                    <defs>
                      <radialGradient id="gradAvatar" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" stop-color="#60a5fa"/>
                        <stop offset="100%" stop-color="#2563eb"/>
                      </radialGradient>
                    </defs>
                    <circle cx="64" cy="64" r="60" fill="url(#gradAvatar)"/>
                    <circle cx="64" cy="50" r="20" fill="#ffffff"/>
                    <path d="M44,90c0-10,8-18,20-18s20,8,20,18v6H44V90z" fill="#ffffff"/>
                  </svg>
                {% endif %}
                {{ reply.author.get_full_name|default:reply.author.username }}
              </span>
            </div>
            <div class="reply-body">
              <p>{{ reply.content }}</p>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
{% empty %}
  <p>No hay comentarios aún. ¡Sé el primero en opinar!</p>
{% endfor %}


      </div>
    </section>

  </main>

{% endblock %}

{% block extra_js %}
  <script>
    const mobileMenuBtn = document.querySelector('.mobile-menu-btn'),
          navMenu = document.querySelector('.nav-menu'),
          themeToggle = document.querySelector('.theme-toggle'),
          html = document.documentElement;

    if (mobileMenuBtn && navMenu) {
      mobileMenuBtn.addEventListener('click', () => navMenu.classList.toggle('active'));
    }

    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        html.dataset.theme = (html.dataset.theme === 'dark') ? 'light' : 'dark';
        localStorage.setItem('theme', html.dataset.theme);
      });
    }

    html.dataset.theme = localStorage.getItem('theme') ||
      (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  </script>

    <script>


    document.addEventListener('DOMContentLoaded', function() {
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const loadingOverlay = document.getElementById('loadingOverlay');

  function showLoading() {
    loadingOverlay.style.display = 'block';
  }
  function hideLoading() {
    loadingOverlay.style.display = 'none';
  }

  // Función genérica para enviar peticiones AJAX
  function sendReaction(url, commentId, callback) {
    showLoading();
    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken
      },
      body: new URLSearchParams({ 'comment_id': commentId })
    })
    .then(response => response.json())
    .then(data => {
      hideLoading();
      callback(data);
    })
    .catch(error => {
      console.error('Error:', error);
      hideLoading();
    });
  }

  // Función para actualizar la UI de reacciones
  function updateReactionUI(commentId, data) {
    // Actualiza botones "me gusta"
    document.querySelectorAll(`.reaction-button[data-comment-id="${commentId}"][data-reaction="like"]`)
      .forEach(el => {
        const likeCount = el.querySelector('.like-count');
        if (likeCount) {
          likeCount.textContent = data.like_count;
        }
        if (data.liked) {
          el.classList.add('active');
        } else {
          el.classList.remove('active');
        }
      });

    // Actualiza botones "no me gusta"
    document.querySelectorAll(`.reaction-button[data-comment-id="${commentId}"][data-reaction="dislike"]`)
      .forEach(el => {
        const dislikeCount = el.querySelector('.dislike-count');
        if (dislikeCount) {
          dislikeCount.textContent = data.dislike_count;
        }
        if (data.disliked) {
          el.classList.add('active');
        } else {
          el.classList.remove('active');
        }
      });
  }

  // Registro de botones de reacciones (like/dislike)
  function registerReactionButtons() {
    document.querySelectorAll('.like-button').forEach(button => {
      button.addEventListener('click', function() {
        const commentId = button.getAttribute('data-comment-id');
        sendReaction("{% url 'toggle_comment_like' %}", commentId, function(data) {
          if (data.error) {
            console.error(data.error);
          } else {
            updateReactionUI(commentId, data);
          }
        });
      });
    });

    document.querySelectorAll('.dislike-button').forEach(button => {
      button.addEventListener('click', function() {
        const commentId = button.getAttribute('data-comment-id');
        sendReaction("{% url 'toggle_comment_dislike' %}", commentId, function(data) {
          if (data.error) {
            console.error(data.error);
          } else {
            updateReactionUI(commentId, data);
          }
        });
      });
    });
  }

  // Registro de botones de borrar comentario
  function registerDeleteButtons() {
    document.querySelectorAll('.delete-comment-button').forEach(button => {
      button.addEventListener('click', function() {
        const commentId = button.getAttribute('data-comment-id');
             // Ahora: customConfirm con promesa
             customConfirm('¿Estás seguro de que deseas borrar este comentario?')
               .then((confirmed) => {
                 if (confirmed) {
                   sendReaction("{% url 'delete_comment' %}", commentId, function(data) {
                     if (data.success) {
                       const commentDiv = document.getElementById(`comment-${commentId}`);
                       if (commentDiv) {
                         commentDiv.remove();
                       }
                     } else {
                       alert(data.error || 'Error al borrar el comentario.');
                     }
                   });
                 }
               });
          });
    });
  }

  // Llamada a funciones de registro
  registerReactionButtons();
  registerDeleteButtons();
});

    </script>

    <script>
  // Sobrescribe alert() para usar un modal personalizado (ya lo tienes).
  window.alert = function(message, redirectUrl = null) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
      <div class="modal-content alert">
        <p>${message}</p>
        <button id="customAlertOkButton">Aceptar</button>
      </div>
    `;
    document.body.appendChild(modal);

    document.getElementById('customAlertOkButton').addEventListener('click', function() {
      modal.remove();
      if (redirectUrl) {
        window.location.href = redirectUrl;
      }
    });
  };

  // Crea una función asíncrona para "confirm()"
  // Devuelve una promesa que resuelve en true (Aceptar) o false (Cancelar)
  function customConfirm(message) {
    return new Promise((resolve) => {
      // Crea el modal
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';
      modal.innerHTML = `
        <div class="modal-content confirm">
          <p>${message}</p>
          <div class="confirm-buttons">
            <button id="customConfirmOkButton">Aceptar</button>
            <button id="customConfirmCancelButton" class="cancel-button">Cancelar</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Manejadores para los botones
      document.getElementById('customConfirmOkButton').addEventListener('click', function() {
        modal.remove();
        resolve(true);  // Usuario aceptó
      });
      document.getElementById('customConfirmCancelButton').addEventListener('click', function() {
        modal.remove();
        resolve(false); // Usuario canceló
      });
    });
  }
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.reaction-button.reply-button').forEach(button => {
      button.addEventListener('click', function() {
        const commentId = button.getAttribute('data-comment-id');
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        replyForm.style.display = (replyForm.style.display === 'none' || replyForm.style.display === '')
          ? 'block'
          : 'none';
      });
    });
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.toggle-replies-button').forEach(function(button) {
      button.addEventListener('click', function() {
        const commentId = button.getAttribute('data-comment-id');
        const repliesDiv = document.getElementById('replies-' + commentId);
        if (repliesDiv.style.display === 'none' || repliesDiv.style.display === '') {
          repliesDiv.style.display = 'block';
          button.textContent = 'Ocultar respuestas ({{ comment.replies.count }})';
        } else {
          repliesDiv.style.display = 'none';
          button.textContent = 'Ver respuestas ({{ comment.replies.count }})';
        }
      });
    });
  });
</script>


{% endblock %}